# README

## Overview

This file highlights the bugs encountered during the process of using javacpp.jar directly on a hello world example.

## Directory Structure

```
tree .
.
├── build
│   ├── macosx-arm64
│   │   ├── libjniHelloPreset.dylib
│   │   └── libmyhello.dylib
│   └── org
│       └── example
│           └── presets
│               └── HelloPreset.class
├── build.sh
├── javacpp.jar
└── src
    └── main
        ├── cpp
        │   ├── myhello.cpp
        │   └── myhello.h
        └── java
            ├── libjniHelloPreset.dylib
            └── org
                └── example
                    ├── Main.java
                    └── presets
                        └── HelloPreset.java
```

## Step-by-Step Guide

### 1. Build the Shared Library

Run the `build.sh` script to create the shared library (`libmyhello.dylib`):

```bash
#!/bin/bash
set -e

echo "removing build/"
rm -rf "build/"

# hardcode mac for now
PLATFORM="macosx-arm64"
OUTPUT_DIR="build/$PLATFORM"

mkdir -p "$OUTPUT_DIR"

g++ -dynamiclib -o "$OUTPUT_DIR/libmyhello.dylib" ./src/main/cpp/myhello.cpp
```

### 2. Compile `HelloPreset.java`

```bash
javac -cp ./javacpp.jar -d build/ src/main/java/org/example/presets/HelloPreset.java
```

### 3. Try to generate `hello.java` and JNI Code

#### Generate `hello.java`

```bash
java -cp javacpp.jar:build org.bytedeco.javacpp.tools.Builder -Dtarget=org.example.hello -Dglobal=org.example.hello  -Dplatform.includepath=src/main/cpp -Dplatform.linkpath=build/macosx-arm64 org.example.presets.HelloPreset -d src/main/java

Exception in thread "main" java.lang.NullPointerException: Cannot invoke "java.util.List.iterator()" because "allInherited" is null
	at org.bytedeco.javacpp.tools.Parser.parse(Parser.java:4631)
	at org.bytedeco.javacpp.tools.Builder.parse(Builder.java:95)
	at org.bytedeco.javacpp.tools.Builder.build(Builder.java:1095)
	at org.bytedeco.javacpp.tools.Builder.main(Builder.java:1450)
```

hello.java fails to generate due to a null pointer exception in the parser.

#### Generate JNI Code

```bash
java -cp javacpp.jar:build org.bytedeco.javacpp.tools.Builder  -Dplatform.includepath=src/main/cpp -Dplatform.linkpath=build/macosx-arm64 org.example.presets.HelloPreset -d build/macosx-arm64
```

The `libjniHelloPreset.dylib` binary doesn't contain the `printHelloWorld2` method

> nm -gU build/macosx-arm64/libjniHelloPreset.dylib

`libmyhello.dylib` does contain the `printHelloWorld2` method.

> nm -gU build/macosx-arm64/libmyhello.dylib
>
> 0000000000003108 T __Z16printHelloWorld2v

### 4. Compile Everything

```bash
javac -cp javacpp.jar:src/main/java -d build/ src/main/java/org/example/*.java
```

### 5. Run the Application

```bash
java -Djava.library.path=./build/macosx-arm64/ -cp build:javacpp-platform-1.5.10-bin/javacpp.jar org.example.Main
```

The app runs only if hello.java and libjniHelloPreset.dylib are replaced by versions generated by maven or gradle.
